<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Postmates Delivery Zones</title>
    <script src="https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.js"></script>
    <link href="https://api.tiles.mapbox.com/mapbox.js/v2.2.3/mapbox.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:400,700" rel="stylesheet" type="text/css" />
    <link href="main.css" rel="stylesheet" />

    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script src="https://api.mapbox.com/mapbox.js/plugins/leaflet-pip/v0.0.2/leaflet-pip.js"></script>

  </head>
<body>
  <div class="sidebar pad2">
    <h2>Postmates Delivery Zones</h2>

    <section>
      <h4>Zip code search</h4>
      <form id="zip_search">
        <input type="text" placeholder="Enter a zip" id="zip_input" />
        <button type="submit">Submit</button>
      </form>
    </section>

    <section>
      <h4>Market list</h4>
      <ul id="listings" class="listings"></ul>
    </section>


  </div>

  <div id="map" class="map"></div>

  <script type="text/javascript">
    const MASHAPE_KEY = '';
    L.mapbox.accessToken = "pk.eyJ1IjoibWFnZXIiLCJhIjoiY2lobWxvZXRpMG90ZXY1a2x4eG4wNGs1NyJ9.vEVHfV_K15rnm4_niRNHYw";

    // Make the map object
    var map;
    map = L.mapbox.map("map", "mapbox.light")
      .setView([37.75, -122.4], 12)
      .addControl(
        L.mapbox.geocoderControl('mapbox.places')
        .on('select', function(e) {
          coords = e.feature.geometry.coordinates;
          var marker = L.marker([coords[1], coords[0]], {
            icon: L.mapbox.marker.icon({
              'marker-size': 'large',
              'marker-symbol': 'heart',
              'marker-color': '#C2C7CA'
            })
          });
          marker.addTo(map);
        })
      );

    // Grab the list on the side and create a new layer on the map
    var listings = document.getElementById('listings');

    var featureLayer = L.mapbox.featureLayer()
      .loadURL('/zones')
      .on('ready', function(e){
        this.setStyle({
          color: '#0077AE',
          weight: 3,
          fillColor: '#4C9FC6'
        });
      })
      .addTo(map);

    function setActive(el) {
      var siblings = listings.getElementsByTagName('li');
      for (var i = 0; i < siblings.length; i++) {
        siblings[i].className = siblings[i].className
        .replace(/active/, '').replace(/\s\s*$/, '');
      }

        el.className += ' active';
    }

    function getZones(data) {
      var zone_name = data.properties.zone_name;
      var map_center = data.features[1].geometry.coordinates.reverse();
      var zoom_level = 11

      // Create some HTML from the GeoJSON
      var listing = listings.appendChild(document.createElement('li'));
      var link = listing.appendChild(document.createElement('a'));
      link.href = '#';
      link.className = 'title';
      link.innerHTML = zone_name;

      link.onclick = function() {
        setActive(listing);
        map.setView(map_center, zoom_level);
        return false;
      };
    }

    $.getJSON('/zones', function(data) {
      for (i=0;i<data.length;i++) {
        getZones(data[i]);
      }
    });

    $('#zip_search').submit(function(e) {
      e.preventDefault();
      var result = $('#zip_input').val();
      get_zip(result);
    });

    function get_zip(q){
      var base_url = 'https://vanitysoft-boundaries-io-v1.p.mashape.com/reaperfire/rest/v1/public/boundary';
      var query_params = '?includepostal=true&limit=1&zipcode=';
      var request_url = `${base_url}${query_params}${q}`;
      console.log(request_url);

      $.ajax({
        url: request_url,
        type: 'GET',
        dataType: 'json',
        beforeSend: function(request) {
          request.setRequestHeader("X-Mashape-Key", MASHAPE_KEY);
          request.setRequestHeader("Accept", "application/json");
        },
        success: function(e) {
          add_zip(e);
        },
        error: function(e) {
          console.log(e);
        }
      });
    }

    function add_zip(zip) {
      L.mapbox.featureLayer().setGeoJSON(zip).addTo(map);
    }

  </script>
</body>
</html>
